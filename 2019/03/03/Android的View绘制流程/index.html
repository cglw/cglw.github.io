<html>
<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">

  
  <title>
    Androidçš„Viewç»˜åˆ¶æµç¨‹ |
    Chen Gang
  </title>
  


  <meta name="description" content="I am g happy boy">
  <meta name="author" content="Chen Gang">
  <meta property="og:title" content="Androidçš„Viewç»˜åˆ¶æµç¨‹">
  <meta property="og:description" content="I am g happy boy">
  <meta property="og:site_name" content="Chen Gang">
  <meta property="og:image" content="http://lwcg.com/img/default.jpg">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:description" content="I am g happy boy">
  <meta name="twitter:title" content="Androidçš„Viewç»˜åˆ¶æµç¨‹">

  <meta name="twitter:image" content="http://lwcg.com/img/default.jpg">

  <script src="https://www.amcharts.com/lib/4/core.js"></script>
  <script src="https://www.amcharts.com/lib/4/charts.js"></script>
  <script src="https://www.amcharts.com/lib/4/themes/animated.js"></script>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/style.css">

</head>

<body>
    <!-- Menu -->
    <nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark page-navbar gradient">
  <div class="container">
    <a class="navbar-brand logo" href="http://lwcg.com">
      Chen Gang</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav"
      aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mx-auto">
        <li class="nav-item item">
          
        <li class="nav-item item">
          <a class="nav-link" href="/">
            Home</a>
        </li>
        
        <li class="nav-item item">
          <a class="nav-link" href="/archives">
            ğŸ—‚ï¸Archives</a>
        </li>
        
        <li class="nav-item item">
          <a class="nav-link" href="https://hexo.io/">
            Hexo</a>
        </li>
        
        </li>
      </ul>
    </div>
  </div>
</nav>

    <main class="page main-page">
        <div class="container blogPost">
    <div class="row">
        <div class="col-sm-9 px-md-5">
            <h2 class="blog-post-title">
                Androidçš„Viewç»˜åˆ¶æµç¨‹
            </h2>
            <p class="meta">
                <i class="far fa-clock"></i>
                2019-03-03 

<a href="/categories/Android/"><i class="far fa-folder-open"></i>
    Android </a>

            </p>
            <!-- Content -->
            <p>æ¦‚è¿°<br>æœ¬ç¯‡æ–‡ç« ä¼šä»æºç ï¼ˆåŸºäºAndroid 6.0ï¼‰è§’åº¦åˆ†æAndroidä¸­Viewçš„ç»˜åˆ¶æµç¨‹ï¼Œä¾§é‡äºå¯¹æ•´ä½“æµç¨‹çš„åˆ†æï¼Œå¯¹ä¸€äº›éš¾ä»¥ç†è§£çš„ç‚¹åŠ ä»¥é‡ç‚¹é˜è¿°ï¼Œç›®çš„æ˜¯æŠŠViewç»˜åˆ¶çš„æ•´ä¸ªæµç¨‹æŠŠæ¡å¥½ï¼Œè€Œå¯¹äºç‰¹å®šå®ç°ç»†èŠ‚åˆ™å¯ä»¥æ—¥åå†å¯¹ç›¸åº”æºç è¿›è¡Œç ”è¯»ã€‚<br>åœ¨è¿›è¡Œå®é™…çš„åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹é¢è¿™å¼ å›¾ï¼š</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2397836-f1f6a200704884a2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="image"></p>
<p>æˆ‘ä»¬æ¥å¯¹ä¸Šå›¾åšå‡ºç®€å•è§£é‡Šï¼šDecorViewæ˜¯ä¸€ä¸ªåº”ç”¨çª—å£çš„æ ¹å®¹å™¨ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªFrameLayoutã€‚DecorViewæœ‰å”¯ä¸€ä¸€ä¸ªå­Viewï¼Œå®ƒæ˜¯ä¸€ä¸ªå‚ç›´LinearLayoutï¼ŒåŒ…å«ä¸¤ä¸ªå­å…ƒç´ ï¼Œä¸€ä¸ªæ˜¯TitleViewï¼ˆActionBarçš„å®¹å™¨ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯ContentViewï¼ˆçª—å£å†…å®¹çš„å®¹å™¨ï¼‰ã€‚å…³äºContentViewï¼Œå®ƒæ˜¯ä¸€ä¸ªFrameLayoutï¼ˆandroid.R.id.content)ï¼Œæˆ‘ä»¬å¹³å¸¸ç”¨çš„setContentViewå°±æ˜¯è®¾ç½®å®ƒçš„å­Viewã€‚ä¸Šå›¾è¿˜è¡¨è¾¾äº†æ¯ä¸ªActivityéƒ½ä¸ä¸€ä¸ªWindowï¼ˆå…·ä½“æ¥è¯´æ˜¯PhoneWindowï¼‰ç›¸å…³è”ï¼Œç”¨æˆ·ç•Œé¢åˆ™ç”±Windowæ‰€æ‰¿è½½ã€‚</p>
<h1 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h1><p>Windowå³çª—å£ï¼Œè¿™ä¸ªæ¦‚å¿µåœ¨Android Frameworkä¸­çš„å®ç°ä¸ºandroid.view.Windowè¿™ä¸ªæŠ½è±¡ç±»ï¼Œè¿™ä¸ªæŠ½è±¡ç±»æ˜¯å¯¹Androidç³»ç»Ÿä¸­çš„çª—å£çš„æŠ½è±¡ã€‚åœ¨ä»‹ç»è¿™ä¸ªç±»ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ç©¶ç«Ÿä»€ä¹ˆæ˜¯çª—å£å‘¢ï¼Ÿ</p>
<p>å®é™…ä¸Šï¼Œçª—å£æ˜¯ä¸€ä¸ªå®è§‚çš„æ€æƒ³ï¼Œå®ƒæ˜¯å±å¹•ä¸Šç”¨äºç»˜åˆ¶å„ç§UIå…ƒç´ åŠå“åº”ç”¨æˆ·è¾“å…¥äº‹ä»¶çš„ä¸€ä¸ªçŸ©å½¢åŒºåŸŸã€‚é€šå¸¸å…·å¤‡ä»¥ä¸‹ä¸¤ä¸ªç‰¹ç‚¹ï¼š</p>
<p>ç‹¬ç«‹ç»˜åˆ¶ï¼Œä¸ä¸å…¶å®ƒç•Œé¢ç›¸äº’å½±å“ï¼›<br>ä¸ä¼šè§¦å‘å…¶å®ƒç•Œé¢çš„è¾“å…¥äº‹ä»¶ï¼›<br>åœ¨Androidç³»ç»Ÿä¸­ï¼Œçª—å£æ˜¯ç‹¬å ä¸€ä¸ªSurfaceå®ä¾‹çš„æ˜¾ç¤ºåŒºåŸŸï¼Œæ¯ä¸ªçª—å£çš„Surfaceç”±WindowManagerServiceåˆ†é…ã€‚æˆ‘ä»¬å¯ä»¥æŠŠSurfaceçœ‹ä½œä¸€å—ç”»å¸ƒï¼Œåº”ç”¨å¯ä»¥é€šè¿‡Canvasæˆ–OpenGLåœ¨å…¶ä¸Šé¢ä½œç”»ã€‚ç”»å¥½ä¹‹åï¼Œé€šè¿‡SurfaceFlingerå°†å¤šå—SurfaceæŒ‰ç…§ç‰¹å®šçš„é¡ºåºï¼ˆå³Z-orderï¼‰è¿›è¡Œæ··åˆï¼Œè€Œåè¾“å‡ºåˆ°FrameBufferä¸­ï¼Œè¿™æ ·ç”¨æˆ·ç•Œé¢å°±å¾—ä»¥æ˜¾ç¤ºã€‚</p>
<p>android.view.Windowè¿™ä¸ªæŠ½è±¡ç±»å¯ä»¥çœ‹åšAndroidä¸­å¯¹çª—å£è¿™ä¸€å®è§‚æ¦‚å¿µæ‰€åšçš„çº¦å®šï¼Œè€ŒPhoneWindowè¿™ä¸ªç±»æ˜¯Frameworkä¸ºæˆ‘ä»¬æä¾›çš„Androidçª—å£æ¦‚å¿µçš„å…·ä½“å®ç°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆæ¥ä»‹ç»ä¸€ä¸‹android.view.Windowè¿™ä¸ªæŠ½è±¡ç±»ã€‚</p>
<p>è¿™ä¸ªæŠ½è±¡ç±»åŒ…å«äº†ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š</p>
<p>WindowManager.LayoutParams: çª—å£çš„å¸ƒå±€å‚æ•°ï¼›<br>Callback: çª—å£çš„å›è°ƒæ¥å£ï¼Œé€šå¸¸ç”±Activityå®ç°ï¼›<br>ViewTree: çª—å£æ‰€æ‰¿è½½çš„æ§ä»¶æ ‘ã€‚<br>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Androidä¸­Windowçš„å…·ä½“å®ç°ï¼ˆä¹Ÿæ˜¯å”¯ä¸€å®ç°ï¼‰â€”â€”PhoneWindowã€‚</p>
<h1 id="PhoneWindow"><a href="#PhoneWindow" class="headerlink" title="PhoneWindow"></a>PhoneWindow</h1><p>å‰é¢æˆ‘ä»¬æåˆ°äº†ï¼ŒPhoneWindowè¿™ä¸ªç±»æ˜¯Frameworkä¸ºæˆ‘ä»¬æä¾›çš„Androidçª—å£çš„å…·ä½“å®ç°ã€‚æˆ‘ä»¬å¹³æ—¶è°ƒç”¨setContentView()æ–¹æ³•è®¾ç½®Activityçš„ç”¨æˆ·ç•Œé¢æ—¶ï¼Œå®é™…ä¸Šå°±å®Œæˆäº†å¯¹æ‰€å…³è”çš„PhoneWindowçš„ViewTreeçš„è®¾ç½®ã€‚æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡Activityç±»çš„requestWindowFeature()æ–¹æ³•æ¥å®šåˆ¶Activityå…³è”PhoneWindowçš„å¤–è§‚ï¼Œè¿™ä¸ªæ–¹æ³•å®é™…ä¸Šåšçš„æ˜¯æŠŠæˆ‘ä»¬æ‰€è¯·æ±‚çš„çª—å£å¤–è§‚ç‰¹æ€§å­˜å‚¨åˆ°äº†PhoneWindowçš„mFeaturesæˆå‘˜ä¸­ï¼Œåœ¨çª—å£ç»˜åˆ¶é˜¶æ®µç”Ÿæˆå¤–è§‚æ¨¡æ¿æ—¶ï¼Œä¼šæ ¹æ®mFeaturesçš„å€¼ç»˜åˆ¶ç‰¹å®šå¤–è§‚ã€‚</p>
<h1 id="ä»setContentView-è¯´å¼€å»"><a href="#ä»setContentView-è¯´å¼€å»" class="headerlink" title="ä»setContentView()è¯´å¼€å»"></a>ä»setContentView()è¯´å¼€å»</h1><p>åœ¨åˆ†æsetContentView()æ–¹æ³•å‰ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®ï¼šè¿™ä¸ªæ–¹æ³•åªæ˜¯å®Œæˆäº†Activityçš„ContentViewçš„åˆ›å»ºï¼Œè€Œå¹¶æ²¡æœ‰æ‰§è¡ŒViewçš„ç»˜åˆ¶æµç¨‹ã€‚<br>å½“æˆ‘ä»¬è‡ªå®šä¹‰Activityç»§æ‰¿è‡ªandroid.app.Activityæ—¶å€™ï¼Œè°ƒç”¨çš„setContentView()æ–¹æ³•æ˜¯Activityç±»çš„ï¼Œæºç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public void setContentView(@LayoutRes int layoutResID) &#123;    </span><br><span class="line">  getWindow().setContentView(layoutResID);    </span><br><span class="line">  . . .</span><br><span class="line">&#125;</span><br><span class="line">getWindow()æ–¹æ³•ä¼šè¿”å›Activityæ‰€å…³è”çš„PhoneWindowï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®é™…ä¸Šè°ƒç”¨åˆ°äº†PhoneWindowçš„setContentView()æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void setContentView(int layoutResID) &#123;</span><br><span class="line">  if (mContentParent == null) &#123;</span><br><span class="line">    // mContentParentå³ä¸ºä¸Šé¢æåˆ°çš„ContentViewçš„çˆ¶å®¹å™¨ï¼Œè‹¥ä¸ºç©ºåˆ™è°ƒç”¨installDecor()ç”Ÿæˆ</span><br><span class="line">    installDecor();</span><br><span class="line">  &#125; else if (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">    // å…·æœ‰FEATURE_CONTENT_TRANSITIONSç‰¹æ€§è¡¨ç¤ºå¼€å¯äº†Transition</span><br><span class="line">    // mContentParentä¸ä¸ºnullï¼Œåˆ™ç§»é™¤decorViewçš„æ‰€æœ‰å­View</span><br><span class="line">    mContentParent.removeAllViews();</span><br><span class="line">  &#125;</span><br><span class="line">  if (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">    // å¼€å¯äº†Transitionï¼Œåšç›¸åº”çš„å¤„ç†ï¼Œæˆ‘ä»¬ä¸è®¨è®ºè¿™ç§æƒ…å†µ</span><br><span class="line">    // æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒæºç </span><br><span class="line">    . . .</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // ä¸€èˆ¬æƒ…å†µä¼šæ¥åˆ°è¿™é‡Œï¼Œè°ƒç”¨mLayoutInflater.inflate()æ–¹æ³•æ¥å¡«å……å¸ƒå±€</span><br><span class="line">    // å¡«å……å¸ƒå±€ä¹Ÿå°±æ˜¯æŠŠæˆ‘ä»¬è®¾ç½®çš„ContentViewåŠ å…¥åˆ°mContentParentä¸­</span><br><span class="line">    mLayoutInflater.inflate(layoutResID, mContentParent);</span><br><span class="line">  &#125;</span><br><span class="line">  . . .</span><br><span class="line">  // cbå³ä¸ºè¯¥Windowæ‰€å…³è”çš„Activity</span><br><span class="line">  final Callback cb = getCallback();</span><br><span class="line">  if (cb != null &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">    // è°ƒç”¨onContentChanged()å›è°ƒæ–¹æ³•é€šçŸ¥Activityçª—å£å†…å®¹å‘ç”Ÿäº†æ”¹å˜</span><br><span class="line">    cb.onContentChanged();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  . . .</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="LayoutInflater-inflate"><a href="#LayoutInflater-inflate" class="headerlink" title="LayoutInflater.inflate()"></a>LayoutInflater.inflate()</h1><p>åœ¨ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°äº†ï¼ŒPhoneWindowçš„setContentView()æ–¹æ³•ä¸­è°ƒç”¨äº†LayoutInflaterçš„inflate()æ–¹æ³•æ¥å¡«å……å¸ƒå±€ï¼Œè¿™ä¸ªæ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public View inflate(@LayoutRes int resource, @Nullable ViewGroup root) &#123;</span><br><span class="line">  return inflate(resource, root, root != null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public View inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot) &#123;</span><br><span class="line">  final Resources res = getContext().getResources();</span><br><span class="line">  . . .</span><br><span class="line">  final XmlResourceParser parser = res.getLayout(resource);</span><br><span class="line">  try &#123;</span><br><span class="line">    return inflate(parser, root, attachToRoot);</span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    parser.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨PhoneWindowçš„setContentView()æ–¹æ³•ä¸­ä¼ å…¥äº†decorViewä½œä¸ºLayoutInflater.inflate()çš„rootå‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡å±‚å±‚è°ƒç”¨ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯inflate(XmlPullParser, ViewGroup, boolean)æ–¹æ³•æ¥å¡«å……å¸ƒå±€ã€‚è¿™ä¸ªæ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">public View inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot) &#123;</span><br><span class="line">  synchronized (mConstructorArgs) &#123;</span><br><span class="line">    . . .</span><br><span class="line">    final Context inflaterContext = mContext;</span><br><span class="line">    final AttributeSet attrs = Xml.asAttributeSet(parser);</span><br><span class="line">    Context lastContext = (Context) mConstructorArgs[0];</span><br><span class="line">    mConstructorArgs[0] = inflaterContext;</span><br><span class="line"></span><br><span class="line">    View result = root;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      // Look for the root node.</span><br><span class="line">      int type;</span><br><span class="line">      // ä¸€ç›´è¯»å–xmlæ–‡ä»¶ï¼Œç›´åˆ°é‡åˆ°å¼€å§‹æ ‡è®°</span><br><span class="line">      while ((type = parser.next()) != XmlPullParser.START_TAG &amp;&amp;</span><br><span class="line">          type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">        // Empty</span><br><span class="line">       &#125;</span><br><span class="line">      // æœ€å…ˆé‡åˆ°çš„ä¸æ˜¯å¼€å§‹æ ‡è®°ï¼ŒæŠ¥é”™</span><br><span class="line">      if (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">        throw new InflateException(parser.getPositionDescription()</span><br><span class="line">+ &quot;: No start tag found!&quot;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      final String name = parser.getName();</span><br><span class="line">      . . .</span><br><span class="line">      // å•ç‹¬å¤„ç†&lt;merge&gt;æ ‡ç­¾ï¼Œä¸ç†Ÿæ‚‰çš„åŒå­¦è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£çš„è¯´æ˜</span><br><span class="line">      if (TAG_MERGE.equals(name)) &#123;</span><br><span class="line">        // è‹¥åŒ…å«&lt;merge&gt;æ ‡ç­¾ï¼Œçˆ¶å®¹å™¨ï¼ˆå³rootå‚æ•°ï¼‰ä¸å¯ä¸ºç©ºä¸”attachRooté¡»ä¸ºtrueï¼Œå¦åˆ™æŠ¥é”™</span><br><span class="line">        if (root == null || !attachToRoot) &#123;</span><br><span class="line">          throw new InflateException(&quot;&lt;merge /&gt; can be used only with a valid &quot;</span><br><span class="line">+ &quot;ViewGroup root and attachToRoot=true&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // é€’å½’åœ°å¡«å……å¸ƒå±€</span><br><span class="line">        rInflate(parser, root, inflaterContext, attrs, false);</span><br><span class="line">     &#125; else &#123;</span><br><span class="line">        // tempä¸ºxmlå¸ƒå±€æ–‡ä»¶çš„æ ¹View</span><br><span class="line">        final View temp = createViewFromTag(root, name, inflaterContext, attrs); </span><br><span class="line">        ViewGroup.LayoutParams params = null;</span><br><span class="line">        if (root != null) &#123;</span><br><span class="line">          . . .</span><br><span class="line">          // è·å–çˆ¶å®¹å™¨çš„å¸ƒå±€å‚æ•°ï¼ˆLayoutParamsï¼‰</span><br><span class="line">          params = root.generateLayoutParams(attrs);</span><br><span class="line">          if (!attachToRoot) &#123;</span><br><span class="line">            // è‹¥attachToRootå‚æ•°ä¸ºfalseï¼Œåˆ™æˆ‘ä»¬åªä¼šå°†çˆ¶å®¹å™¨çš„å¸ƒå±€å‚æ•°è®¾ç½®ç»™æ ¹View</span><br><span class="line">            temp.setLayoutParams(params);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // é€’å½’åŠ è½½æ ¹Viewçš„æ‰€æœ‰å­View</span><br><span class="line">        rInflateChildren(parser, temp, attrs, true);</span><br><span class="line">        . . .</span><br><span class="line"></span><br><span class="line">        if (root != null &amp;&amp; attachToRoot) &#123;</span><br><span class="line">          // è‹¥çˆ¶å®¹å™¨ä¸ä¸ºç©ºä¸”attachToRootä¸ºtrueï¼Œåˆ™å°†çˆ¶å®¹å™¨ä½œä¸ºæ ¹Viewçš„çˆ¶ViewåŒ…è£¹ä¸Šæ¥</span><br><span class="line">          root.addView(temp, params);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        // è‹¥rootä¸ºç©ºæˆ–æ˜¯attachToRootä¸ºfalseï¼Œåˆ™ä»¥æ ¹Viewä½œä¸ºè¿”å›å€¼</span><br><span class="line">        if (root == null || !attachToRoot) &#123;</span><br><span class="line">           result = temp;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125; catch (XmlPullParserException e) &#123;</span><br><span class="line">      . . . </span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      . . . </span><br><span class="line">    &#125; finally &#123;</span><br><span class="line"></span><br><span class="line">      . . .</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨ä¸Šé¢çš„æºç ä¸­ï¼Œé¦–å…ˆå¯¹äºå¸ƒå±€æ–‡ä»¶ä¸­çš„<merge>æ ‡ç­¾è¿›è¡Œå•ç‹¬å¤„ç†ï¼Œè°ƒç”¨rInflate()æ–¹æ³•æ¥é€’å½’å¡«å……å¸ƒå±€ã€‚è¿™ä¸ªæ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">void rInflate(XmlPullParser parser, View parent, Context context,</span><br><span class="line">    AttributeSet attrs, boolean finishInflate) throws XmlPullParserException, IOException &#123;</span><br><span class="line">    // è·å–å½“å‰æ ‡è®°çš„æ·±åº¦ï¼Œæ ¹æ ‡è®°çš„æ·±åº¦ä¸º0</span><br><span class="line">    final int depth = parser.getDepth();</span><br><span class="line">    int type;</span><br><span class="line">    while (((type = parser.next()) != XmlPullParser.END_TAG ||</span><br><span class="line">        parser.getDepth() &gt; depth) &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">      // ä¸æ˜¯å¼€å§‹æ ‡è®°åˆ™ç»§ç»­ä¸‹ä¸€æ¬¡è¿­ä»£</span><br><span class="line">      if (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">        continue;</span><br><span class="line">      &#125;</span><br><span class="line">      final String name = parser.getName();</span><br><span class="line">      // å¯¹ä¸€äº›ç‰¹æ®Šæ ‡è®°åšå•ç‹¬å¤„ç†</span><br><span class="line">      if (TAG_REQUEST_FOCUS.equals(name)) &#123;</span><br><span class="line">        parseRequestFocus(parser, parent);</span><br><span class="line">      &#125; else if (TAG_TAG.equals(name)) &#123;</span><br><span class="line">        parseViewTag(parser, parent, attrs);</span><br><span class="line">      &#125; else if (TAG_INCLUDE.equals(name)) &#123;</span><br><span class="line">        if (parser.getDepth() == 0) &#123;</span><br><span class="line">          throw new InflateException(&quot;&lt;include /&gt; cannot be the root element&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        // å¯¹&lt;include&gt;åšå¤„ç†</span><br><span class="line">        parseInclude(parser, context, parent, attrs);</span><br><span class="line">      &#125; else if (TAG_MERGE.equals(name)) &#123;</span><br><span class="line">        throw new InflateException(&quot;&lt;merge /&gt; must be the root element&quot;);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        // å¯¹ä¸€èˆ¬æ ‡è®°çš„å¤„ç†</span><br><span class="line">        final View view = createViewFromTag(parent, name, context, attrs);</span><br><span class="line">        final ViewGroup viewGroup = (ViewGroup) parent;</span><br><span class="line">        final ViewGroup.LayoutParams params=viewGroup.generateLayoutParams(attrs);</span><br><span class="line">        // é€’å½’åœ°åŠ è½½å­View</span><br><span class="line">        rInflateChildren(parser, view, attrs, true);</span><br><span class="line">        viewGroup.addView(view, params);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (finishInflate) &#123;</span><br><span class="line">        parent.onFinishInflate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></merge></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢çš„inflate()å’ŒrInflate()æ–¹æ³•ä¸­éƒ½è°ƒç”¨äº†rInflateChildren()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š</p>
<p>final void rInflateChildren(XmlPullParser parser, View parent, AttributeSet attrs, boolean finishInflate) throws XmlPullParserException, IOException {<br>    rInflate(parser, parent, parent.getContext(), attrs, finishInflate);<br>}<br>ä»æºç ä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒrInflateChildren()æ–¹æ³•å®é™…ä¸Šè°ƒç”¨äº†rInflate()æ–¹æ³•ã€‚</p>
<p>åˆ°è¿™é‡Œï¼ŒsetContentView()çš„æ•´ä½“æ‰§è¡Œæµç¨‹æˆ‘ä»¬å°±åˆ†æå®Œäº†ï¼Œè‡³æ­¤æˆ‘ä»¬å·²ç»å®Œæˆäº†Activityçš„ContentViewçš„åˆ›å»ºä¸è®¾ç½®å·¥ä½œã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¼€å§‹è¿›å…¥æ­£é¢˜ï¼Œåˆ†æViewçš„ç»˜åˆ¶æµç¨‹ã€‚</p>
<h1 id="ViewRootImpl"><a href="#ViewRootImpl" class="headerlink" title="ViewRootImpl"></a>ViewRootImpl</h1><p>åœ¨ä»‹ç»Viewçš„ç»˜åˆ¶å‰ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“æ˜¯è°è´Ÿè´£æ‰§è¡ŒViewç»˜åˆ¶çš„æ•´ä¸ªæµç¨‹ã€‚å®é™…ä¸Šï¼ŒViewçš„ç»˜åˆ¶æ˜¯ç”±ViewRootæ¥è´Ÿè´£çš„ã€‚æ¯ä¸ªåº”ç”¨ç¨‹åºçª—å£çš„decorViewéƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å…³è”çš„ViewRootå¯¹è±¡ï¼Œè¿™ç§å…³è”å…³ç³»æ˜¯ç”±WindowManageræ¥ç»´æŠ¤çš„ã€‚</p>
<p>é‚£ä¹ˆdecorViewä¸ViewRootçš„å…³è”å…³ç³»æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™å»ºç«‹çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯Activityå¯åŠ¨æ—¶ï¼ŒActivityThread.handleResumeActivity()æ–¹æ³•ä¸­å»ºç«‹äº†å®ƒä»¬ä¸¤è€…çš„å…³è”å…³ç³»ã€‚è¿™é‡Œæˆ‘ä»¬ä¸å…·ä½“åˆ†æå®ƒä»¬å»ºç«‹å…³è”çš„æ—¶æœºä¸æ–¹å¼ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒç›¸å…³æºç ã€‚ä¸‹é¢æˆ‘ä»¬ç›´å…¥ä¸»é¢˜ï¼Œåˆ†æä¸€ä¸‹ViewRootæ˜¯å¦‚ä½•å®ŒæˆViewçš„ç»˜åˆ¶çš„ã€‚</p>
<h1 id="Viewç»˜åˆ¶çš„èµ·ç‚¹"><a href="#Viewç»˜åˆ¶çš„èµ·ç‚¹" class="headerlink" title="Viewç»˜åˆ¶çš„èµ·ç‚¹"></a>Viewç»˜åˆ¶çš„èµ·ç‚¹</h1><p>å½“å»ºç«‹å¥½äº†decorViewä¸ViewRootçš„å…³è”åï¼ŒViewRootç±»çš„requestLayout()æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œä»¥å®Œæˆåº”ç”¨ç¨‹åºç”¨æˆ·ç•Œé¢çš„åˆæ¬¡å¸ƒå±€ã€‚å®é™…è¢«è°ƒç”¨çš„æ˜¯ViewRootImplç±»çš„requestLayout()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void requestLayout() &#123;</span><br><span class="line">  if (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">    // æ£€æŸ¥å‘èµ·å¸ƒå±€è¯·æ±‚çš„çº¿ç¨‹æ˜¯å¦ä¸ºä¸»çº¿ç¨‹  </span><br><span class="line">    checkThread();</span><br><span class="line">    mLayoutRequested = true;</span><br><span class="line">    scheduleTraversals();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢çš„æ–¹æ³•ä¸­è°ƒç”¨äº†scheduleTraversals()æ–¹æ³•æ¥è°ƒåº¦ä¸€æ¬¡å®Œæˆçš„ç»˜åˆ¶æµç¨‹ï¼Œè¯¥æ–¹æ³•ä¼šå‘ä¸»çº¿ç¨‹å‘é€ä¸€ä¸ªâ€œéå†â€æ¶ˆæ¯ï¼Œæœ€ç»ˆä¼šå¯¼è‡´ViewRootImplçš„performTraversals()æ–¹æ³•è¢«è°ƒç”¨ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬ä»¥performTraversals()ä¸ºèµ·ç‚¹ï¼Œæ¥åˆ†æViewçš„æ•´ä¸ªç»˜åˆ¶æµç¨‹ã€‚</p>
<h1 id="ä¸‰ä¸ªé˜¶æ®µ"><a href="#ä¸‰ä¸ªé˜¶æ®µ" class="headerlink" title="ä¸‰ä¸ªé˜¶æ®µ"></a>ä¸‰ä¸ªé˜¶æ®µ</h1><p>Viewçš„æ•´ä¸ªç»˜åˆ¶æµç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µï¼š</p>
<p>measure: åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—Viewçš„å¤§å°ï¼Œéœ€è¦çš„è¯åˆ™è®¡ç®—ï¼›<br>layout: åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—Viewçš„ä½ç½®ï¼Œéœ€è¦çš„è¯åˆ™è®¡ç®—ï¼›<br>draw: åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°ç»˜åˆ¶Viewï¼Œéœ€è¦çš„è¯åˆ™é‡ç»˜åˆ¶ã€‚<br>è¿™ä¸‰ä¸ªå­é˜¶æ®µå¯ä»¥ç”¨ä¸‹å›¾æ¥æè¿°ï¼š<br><img src="https://upload-images.jianshu.io/upload_images/2397836-19c08de6439514a7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="image"><br>measureé˜¶æ®µ<br>æ­¤é˜¶æ®µçš„ç›®çš„æ˜¯è®¡ç®—å‡ºæ§ä»¶æ ‘ä¸­çš„å„ä¸ªæ§ä»¶è¦æ˜¾ç¤ºå…¶å†…å®¹çš„è¯ï¼Œéœ€è¦å¤šå¤§å°ºå¯¸ã€‚èµ·ç‚¹æ˜¯ViewRootImplçš„measureHierarchy()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private boolean measureHierarchy(final View host, final WindowManager.LayoutParams lp, final Resources res, </span><br><span class="line">    final int desiredWindowWidth, final int desiredWindowHeight) &#123;</span><br><span class="line">  // ä¼ å…¥çš„desiredWindowXxxä¸ºçª—å£å°ºå¯¸</span><br><span class="line">  int childWidthMeasureSpec;</span><br><span class="line">  int childHeightMeasureSpec;</span><br><span class="line">  boolean windowSizeMayChange = false;</span><br><span class="line">  . . .</span><br><span class="line">  boolean goodMeasure = false;</span><br><span class="line"></span><br><span class="line">  if (!goodMeasure) &#123;</span><br><span class="line">    childWidthMeasureSpec = getRootMeasureSpec(desiredWindowWidth, lp.width);</span><br><span class="line">    childHeightMeasureSpec = getRootMeasureSpec(desiredWindowHeight, lp.height);</span><br><span class="line">    performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line"></span><br><span class="line">    if (mWidth != host.getMeasuredWidth() || mHeight != host.getMeasuredHeight()) &#123;</span><br><span class="line">      windowSizeMayChange = true;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return windowSizeMayChange;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢çš„ä»£ç ä¸­è°ƒç”¨getRootMeasureSpec()æ–¹æ³•æ¥è·å–æ ¹MeasureSpecï¼Œè¿™ä¸ªæ ¹MeasureSpecä»£è¡¨äº†å¯¹decorViewçš„å®½é«˜çš„çº¦æŸä¿¡æ¯ã€‚ç»§ç»­åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•åœ°ä»‹ç»ä¸‹MeasureSpecçš„æ¦‚å¿µã€‚<br>MeasureSpecæ˜¯ä¸€ä¸ª32ä½æ•´æ•°ï¼Œç”±SpecModeå’ŒSpecSizeä¸¤éƒ¨åˆ†ç»„æˆï¼Œå…¶ä¸­ï¼Œé«˜2ä½ä¸ºSpecModeï¼Œä½30ä½ä¸ºSpecSizeã€‚SpecModeä¸ºæµ‹é‡æ¨¡å¼ï¼ŒSpecSizeä¸ºç›¸åº”æµ‹é‡æ¨¡å¼ä¸‹çš„æµ‹é‡å°ºå¯¸ã€‚Viewï¼ˆåŒ…æ‹¬æ™®é€šViewå’ŒViewGroupï¼‰çš„SpecModeç”±æœ¬Viewçš„LayoutParamsç»“åˆçˆ¶Viewçš„MeasureSpecç”Ÿæˆã€‚<br>SpecModeçš„å–å€¼å¯ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š</p>
<p>EXACTLY: å¯¹å­Viewæå‡ºäº†ä¸€ä¸ªç¡®åˆ‡çš„å»ºè®®å°ºå¯¸ï¼ˆSpecSizeï¼‰ï¼›<br>AT_MOST: å­Viewçš„å¤§å°ä¸å¾—è¶…è¿‡SpecSizeï¼›<br>UNSPECIFIED: å¯¹å­Viewçš„å°ºå¯¸ä¸ä½œé™åˆ¶ï¼Œé€šå¸¸ç”¨äºç³»ç»Ÿå†…éƒ¨ã€‚<br>ä¼ å…¥performMeasure()æ–¹æ³•çš„MeasureSpecçš„SpecModeä¸ºEXACTLYï¼ŒSpecSizeä¸ºçª—å£å°ºå¯¸ã€‚<br>performMeasure()æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private void performMeasure(int childWidthMeasureSpec, int childHeightMeasureSpec) &#123;</span><br><span class="line">  . . .</span><br><span class="line">  try &#123; </span><br><span class="line">    mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    . . .</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢ä»£ç ä¸­çš„mViewå³ä¸ºdecorViewï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šè½¬å‘å¯¹View.measure()æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥ç®—å‡ºä¸€ä¸ªViewåº”è¯¥ä¸ºå¤šå¤§ã€‚å‚æ•°ä¸ºçˆ¶Viewå¯¹å…¶å®½é«˜çš„çº¦æŸä¿¡æ¯ã€‚</span><br><span class="line"> * å®é™…çš„æµ‹é‡å·¥ä½œåœ¨onMeasure()æ–¹æ³•ä¸­è¿›è¡Œ</span><br><span class="line"> */</span><br><span class="line">public final void measure(int widthMeasureSpec, int heightMeasureSpec) &#123;</span><br><span class="line">  . . . </span><br><span class="line">  // åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°å¸ƒå±€</span><br><span class="line"></span><br><span class="line">  // è‹¥mPrivateFlagsä¸­åŒ…å«PFLAG_FORCE_LAYOUTæ ‡è®°ï¼Œåˆ™å¼ºåˆ¶é‡æ–°å¸ƒå±€</span><br><span class="line">  // æ¯”å¦‚è°ƒç”¨View.requestLayout()ä¼šåœ¨mPrivateFlagsä¸­åŠ å…¥æ­¤æ ‡è®°</span><br><span class="line">  final boolean forceLayout = (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT;</span><br><span class="line">  final boolean specChanged = widthMeasureSpec != mOldWidthMeasureSpec</span><br><span class="line">      || heightMeasureSpec != mOldHeightMeasureSpec;</span><br><span class="line">  final boolean isSpecExactly = MeasureSpec.getMode(widthMeasureSpec) == MeasureSpec.EXACTLY</span><br><span class="line">      &amp;&amp; MeasureSpec.getMode(heightMeasureSpec) == MeasureSpec.EXACTLY;</span><br><span class="line">  final boolean matchesSpecSize = getMeasuredWidth() == MeasureSpec.getSize(widthMeasureSpec)</span><br><span class="line">      &amp;&amp; getMeasuredHeight() == MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">  final boolean needsLayout = specChanged</span><br><span class="line">      &amp;&amp; (sAlwaysRemeasureExactly || !isSpecExactly || !matchesSpecSize);</span><br><span class="line"></span><br><span class="line">  // éœ€è¦é‡æ–°å¸ƒå±€  </span><br><span class="line">  if (forceLayout || needsLayout) &#123;</span><br><span class="line">    . . .</span><br><span class="line">    // å…ˆå°è¯•ä»ç¼“ä»ä¸­è·å–ï¼Œè‹¥forceLayoutä¸ºtrueæˆ–æ˜¯ç¼“å­˜ä¸­ä¸å­˜åœ¨æˆ–æ˜¯</span><br><span class="line">    // å¿½ç•¥ç¼“å­˜ï¼Œåˆ™è°ƒç”¨onMeasure()é‡æ–°è¿›è¡Œæµ‹é‡å·¥ä½œ</span><br><span class="line">    int cacheIndex = forceLayout ? -1 : mMeasureCache.indexOfKey(key);</span><br><span class="line">    if (cacheIndex &lt; 0 || sIgnoreMeasureCache) &#123;</span><br><span class="line">      // measure ourselves, this should set the measured dimension flag back</span><br><span class="line">      onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">      . . .</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      // ç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­å–å€¼å³å¯ï¼Œä¸å¿…å†æµ‹é‡</span><br><span class="line">      long value = mMeasureCache.valueAt(cacheIndex);</span><br><span class="line">      // Casting a long to int drops the high 32 bits, no mask needed</span><br><span class="line">      setMeasuredDimensionRaw((int) (value &gt;&gt; 32), (int) value);</span><br><span class="line">      . . .</span><br><span class="line">    &#125;</span><br><span class="line">    . . .</span><br><span class="line">  &#125;</span><br><span class="line">  mOldWidthMeasureSpec = widthMeasureSpec;</span><br><span class="line">  mOldHeightMeasureSpec = heightMeasureSpec;</span><br><span class="line">  mMeasureCache.put(key, ((long) mMeasuredWidth) &lt;&lt; 32 |</span><br><span class="line">      (long) mMeasuredHeight &amp; 0xffffffffL); // suppress sign extension</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä»measure()æ–¹æ³•çš„æºç ä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œåªæœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¹‹ä¸€ï¼Œæ‰ä¼šè¿›è¡Œå®é™…çš„æµ‹é‡å·¥ä½œï¼š</p>
<p>forceLayoutä¸ºtrueï¼šè¿™è¡¨ç¤ºå¼ºåˆ¶é‡æ–°å¸ƒå±€ï¼Œå¯ä»¥é€šè¿‡View.requestLayout()æ¥å®ç°ï¼›<br>needsLayoutä¸ºtrueï¼Œè¿™éœ€è¦specChangedä¸ºtrueï¼ˆè¡¨ç¤ºæœ¬æ¬¡ä¼ å…¥çš„MeasureSpecä¸ä¸Šæ¬¡ä¼ å…¥çš„ä¸åŒï¼‰ï¼Œå¹¶ä¸”ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶ä¹‹ä¸€æˆç«‹ï¼š<br>sAlwaysRemeasureExactlyä¸ºtrue: è¯¥å˜é‡é»˜è®¤ä¸ºfalseï¼›<br>isSpecExactlyä¸ºfalse: è‹¥çˆ¶Viewå¯¹å­Viewæå‡ºäº†ç²¾ç¡®çš„å®½é«˜çº¦æŸï¼Œåˆ™è¯¥å˜é‡ä¸ºtrueï¼Œå¦åˆ™ä¸ºfalse<br>matchesSpecSizeä¸ºfalse: è¡¨ç¤ºçˆ¶Viewçš„å®½é«˜å°ºå¯¸è¦æ±‚ä¸ä¸Šæ¬¡æµ‹é‡çš„ç»“æœä¸åŒ<br>å¯¹äºdecorViewæ¥è¯´ï¼Œå®é™…æ‰§è¡Œæµ‹é‡å·¥ä½œçš„æ˜¯FrameLayoutçš„onMeasure()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</span><br><span class="line">  int count = getChildCount();</span><br><span class="line">  . . .</span><br><span class="line">  int maxHeight = 0;</span><br><span class="line">  int maxWidth = 0;</span><br><span class="line"></span><br><span class="line">  int childState = 0;</span><br><span class="line">  for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">    final View child = getChildAt(i);</span><br><span class="line">    if (mMeasureAllChildren || child.getVisibility() != GONE) &#123;</span><br><span class="line">      measureChildWithMargins(child, widthMeasureSpec, 0, heightMeasureSpec, 0);</span><br><span class="line">      final LayoutParams lp = (LayoutParams) child.getLayoutParams();</span><br><span class="line">      maxWidth = Math.max(maxWidth,</span><br><span class="line">          child.getMeasuredWidth() + lp.leftMargin + lp.rightMargin);</span><br><span class="line">      maxHeight = Math.max(maxHeight,</span><br><span class="line">          child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin);</span><br><span class="line">      childState = combineMeasuredStates(childState, child.getMeasuredState());</span><br><span class="line"></span><br><span class="line">      . . .</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Account for padding too</span><br><span class="line">  maxWidth += getPaddingLeftWithForeground() + getPaddingRightWithForeground();</span><br><span class="line">  maxHeight += getPaddingTopWithForeground() + getPaddingBottomWithForeground();</span><br><span class="line"></span><br><span class="line">  // Check against our minimum height and width</span><br><span class="line">  maxHeight = Math.max(maxHeight, getSuggestedMinimumHeight());</span><br><span class="line">  maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth());</span><br><span class="line"></span><br><span class="line">  // Check against our foreground&apos;s minimum height and width</span><br><span class="line">  final Drawable drawable = getForeground();</span><br><span class="line">  if (drawable != null) &#123;</span><br><span class="line">    maxHeight = Math.max(maxHeight, drawable.getMinimumHeight());</span><br><span class="line">    maxWidth = Math.max(maxWidth, drawable.getMinimumWidth());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),</span><br><span class="line">        resolveSizeAndState(maxHeight, heightMeasureSpec,</span><br><span class="line">        childState &lt;&lt; MEASURED_HEIGHT_STATE_SHIFT));</span><br><span class="line">  . . . </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>FrameLayoutæ˜¯ViewGroupçš„å­ç±»ï¼Œåè€…æœ‰ä¸€ä¸ªView[]ç±»å‹çš„æˆå‘˜å˜é‡mChildrenï¼Œä»£è¡¨äº†å…¶å­Viewé›†åˆã€‚é€šè¿‡getChildAt(i)èƒ½è·å–æŒ‡å®šç´¢å¼•å¤„çš„å­Viewï¼Œé€šè¿‡getChildCount()å¯ä»¥è·å¾—å­Viewçš„æ€»æ•°ã€‚</p>
<p>åœ¨ä¸Šé¢çš„æºç ä¸­ï¼Œé¦–å…ˆè°ƒç”¨measureChildWithMargins()æ–¹æ³•å¯¹æ‰€æœ‰å­Viewè¿›è¡Œäº†ä¸€éæµ‹é‡ï¼Œå¹¶è®¡ç®—å‡ºæ‰€æœ‰å­Viewçš„æœ€å¤§å®½åº¦å’Œæœ€å¤§é«˜åº¦ã€‚è€Œåå°†å¾—åˆ°çš„æœ€å¤§é«˜åº¦å’Œå®½åº¦åŠ ä¸Špaddingï¼Œè¿™é‡Œçš„paddingåŒ…æ‹¬äº†çˆ¶Viewçš„paddingå’Œå‰æ™¯åŒºåŸŸçš„paddingã€‚ç„¶åä¼šæ£€æŸ¥æ˜¯å¦è®¾ç½®äº†æœ€å°å®½é«˜ï¼Œå¹¶ä¸å…¶æ¯”è¾ƒï¼Œå°†ä¸¤è€…ä¸­è¾ƒå¤§çš„è®¾ä¸ºæœ€ç»ˆçš„æœ€å¤§å®½é«˜ã€‚æœ€åï¼Œè‹¥è®¾ç½®äº†å‰æ™¯å›¾åƒï¼Œæˆ‘ä»¬è¿˜è¦æ£€æŸ¥å‰æ™¯å›¾åƒçš„æœ€å°å®½é«˜ã€‚</p>
<p>ç»è¿‡äº†ä»¥ä¸Šä¸€ç³»åˆ—æ­¥éª¤åï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†maxHeightå’ŒmaxWidthçš„æœ€ç»ˆå€¼ï¼Œè¡¨ç¤ºå½“å‰å®¹å™¨Viewç”¨è¿™ä¸ªå°ºå¯¸å°±èƒ½å¤Ÿæ­£å¸¸æ˜¾ç¤ºå…¶æ‰€æœ‰å­Viewï¼ˆåŒæ—¶è€ƒè™‘äº†paddingå’Œmarginï¼‰ã€‚è€Œåæˆ‘ä»¬éœ€è¦è°ƒç”¨resolveSizeAndState()æ–¹æ³•æ¥ç»“åˆä¼ æ¥çš„MeasureSpecæ¥è·å–æœ€ç»ˆçš„æµ‹é‡å®½é«˜ï¼Œå¹¶ä¿å­˜åˆ°mMeasuredWidthä¸mMeasuredHeightæˆå‘˜å˜é‡ä¸­ã€‚</p>
<p>ä»ä»¥ä¸Šä»£ç çš„æ‰§è¡Œæµç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®¹å™¨Viewé€šè¿‡measureChildWithMargins()æ–¹æ³•å¯¹æ‰€æœ‰å­Viewè¿›è¡Œæµ‹é‡åï¼Œæ‰èƒ½å¾—åˆ°è‡ªèº«çš„æµ‹é‡ç»“æœã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºViewGroupåŠå…¶å­ç±»æ¥è¯´ï¼Œè¦å…ˆå®Œæˆå­Viewçš„æµ‹é‡ï¼Œå†è¿›è¡Œè‡ªèº«çš„æµ‹é‡ï¼ˆè€ƒè™‘è¿›paddingç­‰ï¼‰ã€‚<br>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸‹ViewGroupçš„measureChildWithMargins()æ–¹æ³•çš„å®ç°ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">protected void measureChildWithMargins(View child,</span><br><span class="line">  int parentWidthMeasureSpec, int widthUsed,</span><br><span class="line">  int parentHeightMeasureSpec, int heightUsed) &#123;</span><br><span class="line">  final MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</span><br><span class="line">  final int childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,</span><br><span class="line">      mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin + widthUsed, lp.width);</span><br><span class="line">  final int childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec</span><br><span class="line">      mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin + heightUsed, lp.height);</span><br><span class="line"></span><br><span class="line">  child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç”±ä»¥ä¸Šä»£ç æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¯¹äºViewGroupæ¥è¯´ï¼Œå®ƒä¼šè°ƒç”¨child.measure()æ¥å®Œæˆå­Viewçš„æµ‹é‡ã€‚ä¼ å…¥ViewGroupçš„MeasureSpecæ˜¯å®ƒçš„çˆ¶Viewç”¨äºçº¦æŸå…¶æµ‹é‡çš„ï¼Œé‚£ä¹ˆViewGroupæœ¬èº«ä¹Ÿéœ€è¦ç”Ÿæˆä¸€ä¸ªchildMeasureSpecæ¥é™åˆ¶å®ƒçš„å­Viewçš„æµ‹é‡å·¥ä½œã€‚è¿™ä¸ªchildMeasureSpecå°±ç”±getChildMeasureSpec()æ–¹æ³•ç”Ÿæˆã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æè¿™ä¸ªæ–¹æ³•ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public static int getChildMeasureSpec(int spec, int padding, int childDimension) &#123;</span><br><span class="line">  // specä¸ºçˆ¶Viewçš„MeasureSpec</span><br><span class="line">  // paddingä¸ºçˆ¶Viewåœ¨ç›¸åº”æ–¹å‘çš„å·²ç”¨å°ºå¯¸åŠ ä¸Šçˆ¶Viewçš„paddingå’Œå­Viewçš„margin</span><br><span class="line">  // childDimensionä¸ºå­Viewçš„LayoutParamsçš„å€¼</span><br><span class="line">  int specMode = MeasureSpec.getMode(spec);</span><br><span class="line">  int specSize = MeasureSpec.getSize(spec);</span><br><span class="line"></span><br><span class="line">  // ç°åœ¨sizeçš„å€¼ä¸ºçˆ¶Viewç›¸åº”æ–¹å‘ä¸Šçš„å¯ç”¨å¤§å°</span><br><span class="line">  int size = Math.max(0, specSize - padding);</span><br><span class="line"></span><br><span class="line">  int resultSize = 0;</span><br><span class="line">  int resultMode = 0;</span><br><span class="line"></span><br><span class="line">  switch (specMode) &#123;</span><br><span class="line">    // Parent has imposed an exact size on us</span><br><span class="line">    case MeasureSpec.EXACTLY:</span><br><span class="line">      if (childDimension &gt;= 0) &#123;</span><br><span class="line">        // è¡¨ç¤ºå­Viewçš„LayoutParamsæŒ‡å®šäº†å…·ä½“å¤§å°å€¼ï¼ˆxx dpï¼‰</span><br><span class="line">        resultSize = childDimension;</span><br><span class="line">        resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">      &#125; else if (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">        // å­Viewæƒ³å’Œçˆ¶Viewä¸€æ ·å¤§</span><br><span class="line">        resultSize = size;</span><br><span class="line">        resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">      &#125; else if (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">        // å­Viewæƒ³è‡ªå·±å†³å®šå…¶å°ºå¯¸ï¼Œä½†ä¸èƒ½æ¯”çˆ¶Viewå¤§ </span><br><span class="line">        resultSize = size;</span><br><span class="line">        resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">      &#125;</span><br><span class="line">      break;</span><br><span class="line"></span><br><span class="line">    // Parent has imposed a maximum size on us</span><br><span class="line">    case MeasureSpec.AT_MOST:</span><br><span class="line">      if (childDimension &gt;= 0) &#123;</span><br><span class="line">        // å­ViewæŒ‡å®šäº†å…·ä½“å¤§å°</span><br><span class="line">        resultSize = childDimension;</span><br><span class="line">        resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">      &#125; else if (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">        // å­Viewæƒ³è·Ÿçˆ¶Viewä¸€æ ·å¤§ï¼Œä½†æ˜¯çˆ¶Viewçš„å¤§å°æœªå›ºå®šä¸‹æ¥</span><br><span class="line">        // æ‰€ä»¥æŒ‡å®šçº¦æŸå­Viewä¸èƒ½æ¯”çˆ¶Viewå¤§</span><br><span class="line">        resultSize = size;</span><br><span class="line">        resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">      &#125; else if (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">        // å­Viewæƒ³è¦è‡ªå·±å†³å®šå°ºå¯¸ï¼Œä½†ä¸èƒ½æ¯”çˆ¶Viewå¤§</span><br><span class="line">        resultSize = size;</span><br><span class="line">        resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">      &#125;</span><br><span class="line">      break;</span><br><span class="line"></span><br><span class="line">      . . .</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //noinspection ResourceType</span><br><span class="line">  return MeasureSpec.makeMeasureSpec(resultSize, resultMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢çš„æ–¹æ³•å±•ç°äº†æ ¹æ®çˆ¶Viewçš„MeasureSpecå’Œå­Viewçš„LayoutParamsç”Ÿæˆå­Viewçš„MeasureSpecçš„è¿‡ç¨‹ï¼Œ<strong> å­Viewçš„LayoutParamsè¡¨ç¤ºäº†å­Viewçš„æœŸå¾…å¤§å°</strong>ã€‚è¿™ä¸ªäº§ç”Ÿçš„MeasureSpecç”¨äºæŒ‡å¯¼å­Viewè‡ªèº«çš„æµ‹é‡ç»“æœçš„ç¡®å®šã€‚<br>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“ParentMeasureSpecçš„SpecModeä¸ºEXACTLYæ—¶ï¼Œè¡¨ç¤ºçˆ¶Viewå¯¹å­ViewæŒ‡å®šäº†ç¡®åˆ‡çš„å®½é«˜é™åˆ¶ã€‚æ­¤æ—¶æ ¹æ®å­Viewçš„LayoutParamsçš„ä¸åŒï¼Œåˆ†ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p>
<p>å…·ä½“å¤§å°ï¼ˆchildDimensionï¼‰ï¼šè¿™ç§æƒ…å†µä¸‹ä»¤å­Viewçš„SpecSizeä¸ºchildDimensionï¼Œå³å­Viewåœ¨LayoutParamsæŒ‡å®šçš„å…·ä½“å¤§å°å€¼ï¼›ä»¤å­Viewçš„SpecModeä¸ºEXACTLYï¼Œå³è¿™ç§æƒ…å†µä¸‹è‹¥è¯¥å­Viewä¸ºå®¹å™¨Viewï¼Œå®ƒä¹Ÿæœ‰èƒ½åŠ›ç»™å…¶å­ViewæŒ‡å®šç¡®åˆ‡çš„å®½é«˜é™åˆ¶ï¼ˆå­Viewåªèƒ½åœ¨è¿™ä¸ªå®½é«˜èŒƒå›´å†…ï¼‰ï¼Œè‹¥ä¸ºæ™®é€šViewï¼Œå®ƒçš„æœ€ç»ˆæµ‹é‡å¤§å°å°±ä¸ºchildDimensionã€‚<br>match_parentï¼šæ­¤æ—¶è¡¨ç¤ºå­Viewæƒ³å’Œçˆ¶Viewä¸€æ ·å¤§ã€‚è¿™ç§æƒ…å†µä¸‹å¾—åˆ°çš„å­Viewçš„SpecModeä¸ä¸Šç§æƒ…å†µç›¸åŒï¼Œåªä¸è¿‡SpecSizeä¸ºsizeï¼Œå³çˆ¶Viewçš„å‰©ä½™å¯ç”¨å¤§å°ã€‚<br>wrap_content: è¿™è¡¨ç¤ºäº†å­Viewæƒ³è‡ªå·±å†³å®šè‡ªå·±çš„å°ºå¯¸ï¼ˆæ ¹æ®å…¶å†…å®¹çš„å¤§å°åŠ¨æ€å†³å®šï¼‰ã€‚è¿™ç§æƒ…å†µä¸‹å­Viewçš„ç¡®åˆ‡æµ‹é‡å¤§å°åªèƒ½åœ¨å…¶æœ¬èº«çš„onMeasure()æ–¹æ³•ä¸­è®¡ç®—å¾—å‡ºï¼Œçˆ¶Viewæ­¤æ—¶æ— ä»çŸ¥æ™“ã€‚æ‰€ä»¥æš‚æ—¶å°†å­Viewçš„SpecSizeè®¾ä¸ºsizeï¼ˆçˆ¶Viewçš„å‰©ä½™å¤§å°ï¼‰ï¼›ä»¤å­Viewçš„SpecModeä¸ºAT_MOSTï¼Œè¡¨ç¤ºäº†è‹¥å­Viewä¸ºViewGroupï¼Œå®ƒæ²¡æœ‰èƒ½åŠ›ç»™å…¶å­ViewæŒ‡å®šç¡®åˆ‡çš„å®½é«˜é™åˆ¶ï¼Œæ¯•ç«Ÿå®ƒæœ¬èº«çš„æµ‹é‡å®½é«˜è¿˜æ‚¬è€Œæœªå®šã€‚<br>å½“ParentMeasureSpecçš„SpecModeä¸ºAT_MOSTæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®å­Viewçš„LayoutParamsçš„ä¸åŒæ¥åˆ†ä¸‰ç§æƒ…å†µè®¨è®ºï¼š</p>
<p>å…·ä½“å¤§å°ï¼šè¿™æ—¶ä»¤å­Viewçš„SpecSizeä¸ºchildDimensionï¼ŒSpecModeä¸ºEXACTLYã€‚<br>match_parentï¼šè¡¨ç¤ºå­Viewæƒ³å’Œçˆ¶Viewä¸€æ ·å¤§ï¼Œæ•…ä»¤å­Viewçš„SpecSizeä¸ºsizeï¼Œä½†æ˜¯ç”±äºçˆ¶Viewæœ¬èº«çš„æµ‹é‡å®½é«˜è¿˜æ— ä»ç¡®å®šï¼Œæ‰€ä»¥åªæ˜¯æš‚æ—¶ä»¤å­Viewçš„æµ‹é‡ç»“æœä¸ºçˆ¶Viewç›®å‰çš„å¯ç”¨å¤§å°ã€‚è¿™æ—¶ä»¤å­Viewçš„SpecModeä¸ºAT_MOSTã€‚<br>wrap_contentï¼šè¡¨ç¤ºå­Viewæƒ³è‡ªå·±å†³å®šå¤§å°ï¼ˆæ ¹æ®å…¶å†…å®¹åŠ¨æ€ç¡®å®šï¼‰ã€‚ç„¶è€Œè¿™æ—¶çˆ¶Viewè¿˜æ— æ³•ç¡®å®šå…¶è‡ªèº«çš„æµ‹é‡å®½é«˜ï¼Œæ‰€ä»¥æš‚æ—¶ä»¤å­Viewçš„SpecSizeä¸ºsizeï¼ŒSpecModeä¸ºAT_MOSTã€‚<br>ä»ä¸Šé¢çš„åˆ†ææˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªé€šç”¨çš„ç»“è®ºï¼Œå½“å­Viewçš„æµ‹é‡ç»“æœèƒ½å¤Ÿç¡®å®šæ—¶ï¼Œå­Viewçš„SpecModeå°±ä¸ºEXACTLYï¼›å½“å­Viewçš„æµ‹é‡ç»“æœè¿˜ä¸èƒ½ç¡®å®šï¼ˆåªæ˜¯æš‚æ—¶è®¾ä¸ºæŸä¸ªå€¼ï¼‰æ—¶ï¼Œå­Viewçš„SpecModeä¸ºAT_MOSTã€‚<br>åœ¨measureChildWithMargins()æ–¹æ³•ä¸­ï¼Œè·å–äº†çŸ¥é“å­Viewæµ‹é‡çš„MeasureSpecåï¼Œæ¥ä¸‹æ¥å°±è¦è°ƒç”¨child.measure()æ–¹æ³•ï¼Œå¹¶æŠŠè·å–åˆ°çš„childMeasureSpecä¼ å…¥ã€‚è¿™æ—¶ä¾¿åˆä¼šè°ƒç”¨onMeasure()æ–¹æ³•ï¼Œè‹¥æ­¤æ—¶çš„å­Viewä¸ºViewGroupçš„å­ç±»ï¼Œä¾¿ä¼šè°ƒç”¨ç›¸åº”å®¹å™¨ç±»çš„onMeasure()æ–¹æ³•ï¼Œå…¶ä»–å®¹å™¨Viewçš„onMeasure()æ–¹æ³•ä¸FrameLayoutçš„onMeasure()æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ç›¸ä¼¼ã€‚</p>
<p>ä¸‹é¢ä¼šæˆ‘ä»¬å›åˆ°FrameLayoutçš„onMeasure()æ–¹æ³•ï¼Œå½“é€’å½’åœ°æ‰§è¡Œå®Œæ‰€æœ‰å­Viewçš„æµ‹é‡å·¥ä½œåï¼Œä¼šè°ƒç”¨resolveSizeAndState()æ–¹æ³•æ¥æ ¹æ®ä¹‹å‰çš„æµ‹é‡ç»“æœç¡®å®šæœ€ç»ˆå¯¹FrameLayoutçš„æµ‹é‡ç»“æœå¹¶å­˜å‚¨èµ·æ¥ã€‚Viewç±»çš„resolveSizeAndState()æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public static int resolveSizeAndState(int size, int measureSpec, int childMeasuredState) &#123;</span><br><span class="line">  final int specMode = MeasureSpec.getMode(measureSpec);</span><br><span class="line">  final int specSize = MeasureSpec.getSize(measureSpec);</span><br><span class="line">  final int result;</span><br><span class="line">  switch (specMode) &#123;</span><br><span class="line">    case MeasureSpec.AT_MOST:</span><br><span class="line">      if (specSize &lt; size) &#123;</span><br><span class="line">        // çˆ¶Viewç»™å®šçš„æœ€å¤§å°ºå¯¸å°äºå®Œå…¨æ˜¾ç¤ºå†…å®¹æ‰€éœ€å°ºå¯¸</span><br><span class="line">        // åˆ™åœ¨æµ‹é‡ç»“æœä¸ŠåŠ ä¸ŠMEASURED_STATE_TOO_SMALL</span><br><span class="line">        result = specSize | MEASURED_STATE_TOO_SMALL;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">       result = size;</span><br><span class="line">      &#125;</span><br><span class="line">      break;</span><br><span class="line"></span><br><span class="line">    case MeasureSpec.EXACTLY:</span><br><span class="line">      // è‹¥specModeä¸ºEXACTLYï¼Œåˆ™ä¸è€ƒè™‘sizeï¼Œresultç›´æ¥èµ‹å€¼ä¸ºspecSize</span><br><span class="line">      result = specSize;</span><br><span class="line">      break;</span><br><span class="line"></span><br><span class="line">    case MeasureSpec.UNSPECIFIED:</span><br><span class="line">    default:</span><br><span class="line">      result = size;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return result | (childMeasuredState &amp; MEASURED_STATE_MASK);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¯¹äºæ™®é€šViewï¼Œä¼šè°ƒç”¨Viewç±»çš„onMeasure()æ–¹æ³•æ¥è¿›è¡Œå®é™…çš„æµ‹é‡å·¥ä½œï¼Œè¯¥æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</span><br><span class="line">    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</span><br><span class="line">        getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¯¹äºæ™®é€šViewï¼ˆéViewgGroupï¼‰æ¥è¯´ï¼Œåªéœ€å®Œæˆè‡ªèº«çš„æµ‹é‡å·¥ä½œå³å¯ã€‚ä»¥ä¸Šä»£ç ä¸­é€šè¿‡setMeasuredDimension()æ–¹æ³•è®¾ç½®æµ‹é‡çš„ç»“æœï¼Œå…·ä½“æ¥è¯´æ˜¯ä»¥getDefaultSize()æ–¹æ³•çš„è¿”å›å€¼æ¥ä½œä¸ºæµ‹é‡ç»“æœã€‚getDefaultSize()æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public static int getDefaultSize(int size, int measureSpec) &#123;</span><br><span class="line">  int result = size;</span><br><span class="line">  int specMode = MeasureSpec.getMode(measureSpec);</span><br><span class="line">  int specSize = MeasureSpec.getSize(measureSpec);</span><br><span class="line">  switch (specMode) &#123;</span><br><span class="line">    case MeasureSpec.UNSPECIFIED:</span><br><span class="line">      result = size;</span><br><span class="line">      break;</span><br><span class="line">    case MeasureSpec.AT_MOST:</span><br><span class="line">    case MeasureSpec.EXACTLY:</span><br><span class="line">      result = specSize;</span><br><span class="line">      break;</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç”±ä»¥ä¸Šä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒViewçš„getDefaultSize()æ–¹æ³•å¯¹äºAT_MOSTå’ŒEXACTLYè¿™ä¸¤ç§æƒ…å†µéƒ½è¿”å›äº†SpecSizeä½œä¸ºresultã€‚æ‰€ä»¥è‹¥æˆ‘ä»¬çš„è‡ªå®šä¹‰Viewç›´æ¥ç»§æ‰¿äº†Viewç±»ï¼Œæˆ‘ä»¬å°±è¦è‡ªå·±å¯¹wrap_content (å¯¹åº”äº†AT_MOST)è¿™ç§æƒ…å†µè¿›è¡Œå¤„ç†ï¼Œå¦åˆ™å¯¹è‡ªå®šä¹‰ViewæŒ‡å®šwrap_contentå°±å’Œmatch_parentæ•ˆæœä¸€æ ·äº†ã€‚</p>
<h1 id="layouté˜¶æ®µ"><a href="#layouté˜¶æ®µ" class="headerlink" title="layouté˜¶æ®µ"></a>layouté˜¶æ®µ</h1><p>layouté˜¶æ®µçš„åŸºæœ¬æ€æƒ³ä¹Ÿæ˜¯ç”±æ ¹Viewå¼€å§‹ï¼Œé€’å½’åœ°å®Œæˆæ•´ä¸ªæ§ä»¶æ ‘çš„å¸ƒå±€ï¼ˆlayoutï¼‰å·¥ä½œã€‚</p>
<h1 id="View-layout"><a href="#View-layout" class="headerlink" title="View.layout()"></a>View.layout()</h1><p>æˆ‘ä»¬æŠŠå¯¹decorViewçš„layout()æ–¹æ³•çš„è°ƒç”¨ä½œä¸ºå¸ƒå±€æ•´ä¸ªæ§ä»¶æ ‘çš„èµ·ç‚¹ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯Viewç±»çš„layout()æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public void layout(int l, int t, int r, int b) &#123;</span><br><span class="line">    // lä¸ºæœ¬Viewå·¦è¾¹ç¼˜ä¸çˆ¶Viewå·¦è¾¹ç¼˜çš„è·ç¦»</span><br><span class="line">    // tä¸ºæœ¬Viewä¸Šè¾¹ç¼˜ä¸çˆ¶Viewä¸Šè¾¹ç¼˜çš„è·ç¦»</span><br><span class="line">    // rä¸ºæœ¬Viewå³è¾¹ç¼˜ä¸çˆ¶Viewå·¦è¾¹ç¼˜çš„è·ç¦»</span><br><span class="line">    // bä¸ºæœ¬Viewä¸‹è¾¹ç¼˜ä¸çˆ¶Viewä¸Šè¾¹ç¼˜çš„è·ç¦»</span><br><span class="line">    . . .</span><br><span class="line">    boolean changed = isLayoutModeOptical(mParent) ?            setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</span><br><span class="line">    if (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;</span><br><span class="line">        onLayout(changed, l, t, r, b);</span><br><span class="line">        . . .</span><br><span class="line">            </span><br><span class="line">    &#125;</span><br><span class="line">    . . .</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªæ–¹æ³•ä¼šè°ƒç”¨setFrame()æ–¹æ³•æ¥è®¾ç½®Viewçš„mLeftã€mTopã€mRightå’ŒmBottomå››ä¸ªå‚æ•°ï¼Œè¿™å››ä¸ªå‚æ•°æè¿°äº†Viewç›¸å¯¹å…¶çˆ¶Viewçš„ä½ç½®ï¼ˆåˆ†åˆ«èµ‹å€¼ä¸ºl, t, r, bï¼‰ï¼Œåœ¨setFrame()æ–¹æ³•ä¸­ä¼šåˆ¤æ–­Viewçš„ä½ç½®æ˜¯å¦å‘ç”Ÿäº†æ”¹å˜ï¼Œè‹¥å‘ç”Ÿäº†æ”¹å˜ï¼Œåˆ™éœ€è¦å¯¹å­Viewè¿›è¡Œé‡æ–°å¸ƒå±€ï¼Œå¯¹å­Viewçš„å±€éƒ¨æ˜¯é€šè¿‡onLayout()æ–¹æ³•å®ç°äº†ã€‚ç”±äºæ™®é€šViewï¼ˆ éViewGroupï¼‰ä¸å«å­Viewï¼Œæ‰€ä»¥Viewç±»çš„onLayout()æ–¹æ³•ä¸ºç©ºã€‚å› æ­¤æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹ViewGroupç±»çš„onLayout()æ–¹æ³•çš„å®ç°ã€‚</p>
<h1 id="ViewGroup-onLayout"><a href="#ViewGroup-onLayout" class="headerlink" title="ViewGroup.onLayout()"></a>ViewGroup.onLayout()</h1><p>å®é™…ä¸ŠViewGroupç±»çš„onLayout()æ–¹æ³•æ˜¯abstractï¼Œè¿™æ˜¯å› ä¸ºä¸åŒçš„å¸ƒå±€ç®¡ç†å™¨æœ‰ç€ä¸åŒçš„å¸ƒå±€æ–¹å¼ã€‚<br>è¿™é‡Œæˆ‘ä»¬ä»¥decorViewï¼Œä¹Ÿå°±æ˜¯FrameLayoutçš„onLayout()æ–¹æ³•ä¸ºä¾‹ï¼Œåˆ†æViewGroupçš„å¸ƒå±€è¿‡ç¨‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void onLayout(boolean changed, int left, int top, int right, int bottom) &#123;</span><br><span class="line">  layoutChildren(left, top, right, bottom, false /* no force left gravity */);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void layoutChildren(int left, int top, int right, int bottom, boolean forceLeftGravity) &#123;</span><br><span class="line">  final int count = getChildCount();</span><br><span class="line">  final int parentLeft = getPaddingLeftWithForeground();</span><br><span class="line">  final int parentRight = right - left - getPaddingRightWithForeground();</span><br><span class="line">  final int parentTop = getPaddingTopWithForeground();</span><br><span class="line">  final int parentBottom = bottom - top - getPaddingBottomWithForeground();</span><br><span class="line"></span><br><span class="line">  for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">    final View child = getChildAt(i);</span><br><span class="line">    if (child.getVisibility() != GONE) &#123;</span><br><span class="line">      final LayoutParams lp = (LayoutParams) child.getLayoutParams();</span><br><span class="line">      final int width = child.getMeasuredWidth();</span><br><span class="line">      final int height = child.getMeasuredHeight();</span><br><span class="line">      int childLeft;</span><br><span class="line">      int childTop;</span><br><span class="line">      int gravity = lp.gravity;</span><br><span class="line"></span><br><span class="line">      if (gravity == -1) &#123;</span><br><span class="line">        gravity = DEFAULT_CHILD_GRAVITY;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      final int layoutDirection = getLayoutDirection();</span><br><span class="line">      final int absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection);</span><br><span class="line">      final int verticalGravity = gravity &amp; Gravity.VERTICAL_GRAVITY_MASK;</span><br><span class="line"></span><br><span class="line">      switch (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) &#123;</span><br><span class="line">        case Gravity.CENTER_HORIZONTAL:</span><br><span class="line">          childLeft = parentLeft + (parentRight - parentLeft - width) / 2 +</span><br><span class="line">lp.leftMargin - lp.rightMargin;</span><br><span class="line">          break;</span><br><span class="line"></span><br><span class="line">        case Gravity.RIGHT:</span><br><span class="line">          if (!forceLeftGravity) &#123;</span><br><span class="line">            childLeft = parentRight - width - lp.rightMargin;</span><br><span class="line">            break;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        case Gravity.LEFT:</span><br><span class="line">        default:</span><br><span class="line">          childLeft = parentLeft + lp.leftMargin;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      switch (verticalGravity) &#123;</span><br><span class="line">        case Gravity.TOP:</span><br><span class="line">          childTop = parentTop + lp.topMargin;</span><br><span class="line">          break;</span><br><span class="line"></span><br><span class="line">        case Gravity.CENTER_VERTICAL:</span><br><span class="line">          childTop = parentTop + (parentBottom - parentTop - height) / 2 +</span><br><span class="line">lp.topMargin - lp.bottomMargin;</span><br><span class="line">          break;</span><br><span class="line"></span><br><span class="line">        case Gravity.BOTTOM:</span><br><span class="line">          childTop = parentBottom - height - lp.bottomMargin;</span><br><span class="line">          break;</span><br><span class="line"></span><br><span class="line">        default:</span><br><span class="line">          childTop = parentTop + lp.topMargin;</span><br><span class="line">      &#125;</span><br><span class="line">      child.layout(childLeft, childTop, childLeft + width, childTop + height);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨ä¸Šé¢çš„æ–¹æ³•ä¸­ï¼ŒparentLeftè¡¨ç¤ºå½“å‰Viewä¸ºå…¶å­Viewæ˜¾ç¤ºåŒºåŸŸæŒ‡å®šçš„ä¸€ä¸ªå·¦è¾¹ç•Œï¼Œä¹Ÿå°±æ˜¯å­Viewæ˜¾ç¤ºåŒºåŸŸçš„å·¦è¾¹ç¼˜åˆ°çˆ¶Viewçš„å·¦è¾¹ç¼˜çš„è·ç¦»ï¼ŒparentRightã€parentTopã€parentBottomçš„å«ä¹‰åŒç†ã€‚ç¡®å®šäº†å­Viewçš„æ˜¾ç¤ºåŒºåŸŸåï¼Œæ¥ä¸‹æ¥ï¼Œç”¨ä¸€ä¸ªforå¾ªç¯æ¥å®Œæˆå­Viewçš„å¸ƒå±€ã€‚<br>åœ¨ç¡®ä¿å­Viewçš„å¯è§æ€§ä¸ä¸ºGONEçš„æƒ…å†µä¸‹æ‰ä¼šå¯¹å…¶è¿›è¡Œå¸ƒå±€ã€‚é¦–å…ˆä¼šè·å–å­Viewçš„LayoutParamsã€layoutDirectionç­‰ä¸€ç³»åˆ—å‚æ•°ã€‚ä¸Šé¢ä»£ç ä¸­çš„childLeftä»£è¡¨äº†æœ€ç»ˆå­Viewçš„å·¦è¾¹ç¼˜è·çˆ¶Viewå·¦è¾¹ç¼˜çš„è·ç¦»ï¼ŒchildTopä»£è¡¨äº†å­Viewçš„ä¸Šè¾¹ç¼˜è·çˆ¶Viewçš„ä¸Šè¾¹ç¼˜çš„è·ç¦»ã€‚ä¼šæ ¹æ®å­Viewçš„layout_gravityçš„å–å€¼å¯¹childLeftå’ŒchildTopåšå‡ºä¸åŒçš„è°ƒæ•´ã€‚æœ€åä¼šè°ƒç”¨child.layout()æ–¹æ³•å¯¹å­Viewçš„ä½ç½®å‚æ•°è¿›è¡Œè®¾ç½®ï¼Œè¿™æ—¶ä¾¿è½¬åˆ°äº†View.layout()æ–¹æ³•çš„è°ƒç”¨ï¼Œè‹¥å­Viewæ˜¯å®¹å™¨Viewï¼Œåˆ™ä¼šé€’å½’åœ°å¯¹å…¶å­Viewè¿›è¡Œå¸ƒå±€ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œlayouté˜¶æ®µçš„å¤§è‡´æµç¨‹æˆ‘ä»¬å°±åˆ†æå®Œäº†ï¼Œè¿™ä¸ªé˜¶æ®µä¸»è¦å°±æ˜¯æ ¹æ®ä¸Šä¸€é˜¶æ®µå¾—åˆ°çš„Viewçš„æµ‹é‡å®½é«˜æ¥ç¡®å®šViewçš„æœ€ç»ˆæ˜¾ç¤ºä½ç½®ã€‚æ˜¾ç„¶ï¼Œç»è¿‡äº†measureé˜¶æ®µå’Œlayouté˜¶æ®µï¼Œæˆ‘ä»¬å·²ç»ç¡®å®šå¥½äº†Viewçš„å¤§å°å’Œä½ç½®ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹ç»˜åˆ¶Viewäº†ã€‚</p>
<h1 id="drawé˜¶æ®µ"><a href="#drawé˜¶æ®µ" class="headerlink" title="drawé˜¶æ®µ"></a>drawé˜¶æ®µ</h1><p>å¯¹äºæœ¬é˜¶æ®µçš„åˆ†æï¼Œæˆ‘ä»¬ä»¥decorView.draw()ä½œä¸ºåˆ†æçš„èµ·ç‚¹ï¼Œä¹Ÿå°±æ˜¯View.draw()æ–¹æ³•ï¼Œå®ƒçš„æºç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public void draw(Canvas canvas) &#123;</span><br><span class="line">  . . . </span><br><span class="line">  // ç»˜åˆ¶èƒŒæ™¯ï¼Œåªæœ‰dirtyOpaqueä¸ºfalseæ—¶æ‰è¿›è¡Œç»˜åˆ¶ï¼Œä¸‹åŒ</span><br><span class="line">  int saveCount;</span><br><span class="line">  if (!dirtyOpaque) &#123;</span><br><span class="line">    drawBackground(canvas);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  . . . </span><br><span class="line"></span><br><span class="line">  // ç»˜åˆ¶è‡ªèº«å†…å®¹</span><br><span class="line">  if (!dirtyOpaque) onDraw(canvas);</span><br><span class="line"></span><br><span class="line">  // ç»˜åˆ¶å­View</span><br><span class="line">  dispatchDraw(canvas);</span><br><span class="line"></span><br><span class="line">   . . .</span><br><span class="line">  // ç»˜åˆ¶æ»šåŠ¨æ¡ç­‰</span><br><span class="line">  onDrawForeground(canvas);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç®€å•èµ·è§ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬çœç•¥äº†å®ç°æ»‘åŠ¨æ—¶æ¸å˜è¾¹æ¡†æ•ˆæœç›¸å…³çš„é€»è¾‘ã€‚å®é™…ä¸Šï¼ŒViewç±»çš„onDraw()æ–¹æ³•ä¸ºç©ºï¼Œå› ä¸ºæ¯ä¸ªViewç»˜åˆ¶è‡ªèº«çš„æ–¹å¼éƒ½ä¸å°½ç›¸åŒï¼Œå¯¹äºdecorViewæ¥è¯´ï¼Œç”±äºå®ƒæ˜¯å®¹å™¨Viewï¼Œæ‰€ä»¥å®ƒæœ¬èº«å¹¶æ²¡æœ‰ä»€ä¹ˆè¦ç»˜åˆ¶çš„ã€‚dispatchDraw()æ–¹æ³•ç”¨äºç»˜åˆ¶å­Viewï¼Œæ˜¾ç„¶æ™®é€šViewï¼ˆéViewGroupï¼‰å¹¶ä¸èƒ½åŒ…å«å­Viewï¼Œæ‰€ä»¥Viewç±»ä¸­è¿™ä¸ªæ–¹æ³•çš„å®ç°ä¸ºç©ºã€‚</p>
<p>ViewGroupç±»çš„dispatchDraw()æ–¹æ³•ä¸­ä¼šä¾æ¬¡è°ƒç”¨drawChild()æ–¹æ³•æ¥ç»˜åˆ¶å­Viewï¼ŒdrawChild()æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected boolean drawChild(Canvas canvas, View child, long drawingTime) &#123;</span><br><span class="line">  return child.draw(canvas, this, drawingTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªæ–¹æ³•è°ƒç”¨äº†View.draw(Canvas, ViewGroupï¼Œlong)æ–¹æ³•æ¥å¯¹å­Viewè¿›è¡Œç»˜åˆ¶ã€‚åœ¨draw(Canvas, ViewGroup, long)æ–¹æ³•ä¸­ï¼Œé¦–å…ˆå¯¹canvasè¿›è¡Œäº†ä¸€ç³»åˆ—å˜æ¢ï¼Œä»¥å˜æ¢åˆ°å°†è¦è¢«ç»˜åˆ¶çš„Viewçš„åæ ‡ç³»ä¸‹ã€‚å®Œæˆå¯¹canvasçš„å˜æ¢åï¼Œä¾¿ä¼šè°ƒç”¨View.draw(Canvas)æ–¹æ³•è¿›è¡Œå®é™…çš„ç»˜åˆ¶å·¥ä½œï¼Œæ­¤æ—¶ä¼ å…¥çš„canvasä¸ºç»è¿‡å˜æ¢çš„ï¼Œåœ¨å°†è¢«ç»˜åˆ¶Viewçš„åæ ‡ç³»ä¸‹çš„canvasã€‚</p>
<p>è¿›å…¥åˆ°View.draw(Canvas)æ–¹æ³•åï¼Œä¼šå‘ä¹‹å‰ä»‹ç»çš„ä¸€æ ·ï¼Œæ‰§è¡Œä»¥ä¸‹å‡ æ­¥ï¼š</p>
<p>ç»˜åˆ¶èƒŒæ™¯;<br>é€šè¿‡onDraw()ç»˜åˆ¶è‡ªèº«å†…å®¹;<br>é€šè¿‡dispatchDraw()ç»˜åˆ¶å­View;<br>ç»˜åˆ¶æ»šåŠ¨æ¡</p>
<p>æ€»ç»“<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A--&gt;B</span><br><span class="line">B--&gt;C</span><br><span class="line">C--&gt;A</span><br></pre></td></tr></table></figure></p>

            <br />
            <p class="meta">
                
            </p>
        </div>

        <div class="col-sm-3">
             
<span><b> TL;DR</b></span>
<p>
	Yet another hexo theme.
</p>
<hr />


<span><b> TL;DR 2</b></span>
<p>
	No, not another one :/
</p>
<hr />

 

<span
	><a href="https://twitter.com/hexojs" target="_blank" rel="noopener"
		><b
			><i class="fab fa-twitter-square"></i>
			<i class="fas fa-at"></i>
			hexojs</b
		></a
	></span
>
<br />
<a class="twitter-timeline" data-height="800" data-dnt="true" data-chrome="nofooter transparent noheader noborders " href="https://twitter.com/hexojs?ref_src=twsrc%5Etfw"></a>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


        </div>
    </div>
</div>
<!-- Menu fade on scroll -->
<script>
    var isScrolling;
    var prevScrollpos = window.pageYOffset;
    window.addEventListener(
        'scroll',
        function(event) {
            window.clearTimeout(isScrolling);
            isScrolling = setTimeout(function() {
                var currentScrollPos = window.pageYOffset;
                if (prevScrollpos > currentScrollPos) {
                    $('#navbar').slideDown();
                } else {
                    $('#navbar').slideUp();
                }
                prevScrollpos = currentScrollPos;
            }, 66);
        },
        false
    );
</script>


<a class="float-left gradient btn paginationbtn" href="/2019/03/01/Androidçš„Viewç›¸å…³/"><i class="fas fa-chevron-left"></i></a>


<a class="float-right gradient btn paginationbtn" href="/2019/03/08/Androidçš„Appä¸€äº›ä¼˜åŒ–æ–¹æ¡ˆ/"><i class="fas fa-chevron-right"></i></a>

    </main>
    <!-- Footer -->
    <footer class="page-footer">
  <div class="container">
    <div class="social-icons">
      
      <a href="https://hexo.io/" title="Hexo.io" target="_blank" rel="noopener" class="fas fa-home"></a>
      
      <a href="https://twitter.com/hexojs" title="@hexojs" target="_blank" rel="noopener" class="fab fa-twitter"></a>
      
      <a href="https://github.com/RandomAdversary/Gradient/issues" title="Report issue" target="_blank" rel="noopener" class="fas fa-bug"></a>
      
    </div>
  </div>
</footer>
    <!-- After footer scripts -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>
</body>

</html>